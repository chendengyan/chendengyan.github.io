<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>股票投资决策实验</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #1a2980 0%, #26d0ce 100%);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(to right, #1a2980, #26d0ce);
            color: white;
            padding: 25px 40px;
            text-align: center;
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr;
            gap: 25px;
            padding: 30px;
        }
        
        @media (min-width: 992px) {
            .main-content {
                grid-template-columns: 1.5fr 1fr;
            }
        }
        
        .chart-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            padding: 25px;
        }
        
        .panel-title {
            font-size: 1.5rem;
            color: #1a2980;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eef2f7;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .panel-title i {
            color: #26d0ce;
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .stock-info {
            background: #e8f4fc;
            padding: 12px 20px;
            border-radius: 10px;
            font-weight: 600;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .stock-info-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .stock-info-item .label {
            color: #5a6b7c;
        }
        
        .stock-info-item .value {
            font-weight: 700;
            color: #1a2980;
        }
        
        .chart-container {
            height: 400px;
            position: relative;
        }
        
        #stockChart {
            width: 100% !important;
            height: 100% !important;
        }
        
        .time-filters {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .time-btn {
            padding: 8px 15px;
            background: #f0f7ff;
            border: 1px solid #d1e3f8;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .time-btn:hover, .time-btn.active {
            background: #1a2980;
            color: white;
            border-color: #1a2980;
        }
        
        .decision-section {
            display: grid;
            gap: 25px;
        }
        
        .investment-panel, .ai-panel {
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            padding: 25px;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        .input-label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 1.1rem;
        }
        
        .input-field {
            width: 100%;
            padding: 14px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1.1rem;
            transition: all 0.3s ease;
        }
        
        .input-field:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }
        
        .btn {
            background: linear-gradient(to right, #1a2980, #26d0ce);
            color: white;
            border: none;
            padding: 14px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(26, 41, 128, 0.4);
        }
        
        .btn:disabled {
            background: linear-gradient(to right, #cccccc, #e0e0e0);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .ai-panel {
            position: relative;
        }
        
        .ai-agents {
            display: grid;
            gap: 20px;
            margin-top: 20px;
        }
        
        .ai-agent {
            border: 1px solid #e1e8ed;
            border-radius: 12px;
            padding: 20px;
            background: #f9fbfd;
            transition: all 0.3s ease;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.05);
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s ease, transform 0.5s ease;
        }
        
        .ai-agent.visible {
            opacity: 1;
            transform: translateY(0);
        }
        
        .ai-agent:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
            border-color: #c5d9e8;
        }
        
        .agent-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .agent-icon {
            width: 46px;
            height: 46px;
            border-radius: 50%;
            background: linear-gradient(135deg, #1a2980, #26d0ce);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
            margin-right: 15px;
        }
        
        .agent-name {
            font-weight: 700;
            font-size: 1.2rem;
            color: #1a2980;
        }
        
        .thinking {
            display: flex;
            gap: 5px;
            margin-left: 10px;
        }
        
        .dot {
            width: 8px;
            height: 8px;
            background: #5a6b7c;
            border-radius: 50%;
            animation: pulse 1.5s infinite ease-in-out;
        }
        
        .dot:nth-child(1) {
            animation-delay: 0s;
        }
        
        .dot:nth-child(2) {
            animation-delay: 0.3s;
        }
        
        .dot:nth-child(3) {
            animation-delay: 0.6s;
        }
        
        @keyframes pulse {
            0%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            50% {
                transform: scale(1.2);
                opacity: 1;
            }
        }
        
        .advice-content {
            margin-left: 61px;
        }
        
        .recommendation {
            font-size: 1.1rem;
            margin-bottom: 10px;
            color: #2c3e50;
            font-weight: 500;
        }
        
        .confidence {
            display: inline-block;
            padding: 6px 12px;
            background: #e1f0fa;
            border-radius: 20px;
            font-size: 0.95rem;
            margin-bottom: 10px;
            font-weight: 600;
            color: #1a2980;
        }
        
        .alternative-options {
            margin-top: 15px;
            padding-left: 20px;
            border-left: 3px solid #3498db;
            font-size: 0.95rem;
        }
        
        .alternative-options div {
            margin-bottom: 12px;
            padding: 10px 0;
            border-bottom: 1px dashed #eee;
            line-height: 1.5;
        }
        
        .alternative-options small {
            color: #7f8c8d;
            font-size: 0.85rem;
            display: block;
            margin-top: 4px;
        }
        
        .reasoning {
            margin-top: 15px;
            font-style: normal;
            color: #5a6b7c;
            background: #f8fafc;
            padding: 15px;
            border-radius: 8px;
            border-left: 3px solid #26d0ce;
            font-size: 0.95rem;
            line-height: 1.5;
        }
        
        .result-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .result-modal.active {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
            transform: translateY(20px);
            transition: transform 0.4s ease;
        }
        
        .result-modal.active .modal-content {
            transform: translateY(0);
        }
        
        .modal-header {
            text-align: center;
            margin-bottom: 25px;
            position: relative;
        }
        
        .modal-title {
            font-size: 1.8rem;
            color: #1a2980;
            margin-bottom: 10px;
        }
        
        .result-details {
            margin: 20px 0;
        }
        
        .result-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }
        
        .result-label {
            font-weight: 600;
            color: #5a6b7c;
        }
        
        .result-value {
            font-weight: 700;
            color: #1a2980;
        }
        
        .close-btn {
            background: #1a2980;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            width: 100%;
            transition: all 0.3s ease;
        }
        
        .close-btn:hover {
            background: #0e1a5a;
            transform: translateY(-2px);
        }
        
        footer {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
            font-size: 0.9rem;
            border-top: 1px solid #eee;
        }
        
        .export-section {
            margin: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            text-align: center;
        }
        
        .export-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-top: 15px;
        }
        
        .export-btn:hover {
            background: #218838;
            transform: translateY(-2px);
        }
        
        .export-btn i {
            margin-right: 8px;
        }
        
        .investment-rules {
            background: #f0f7ff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #d1e3f8;
        }
        
        .investment-rules h3 {
            color: #1a2980;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        
        .investment-rules ul {
            padding-left: 20px;
            color: #5a6b7c;
        }
        
        .investment-rules li {
            margin-bottom: 8px;
            font-size: 0.95rem;
        }
        
        .admin-section {
            position: absolute;
            top: 10px;
            right: 10px;
        }
        
        .admin-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-chart-line"></i> 股票投资决策实验</h1>
            <p class="subtitle">观察股票走势，做出投资决策，查看AI建议，调整您的策略</p>
        </header>
        
        <div class="main-content">
            <div class="chart-section">
                <div class="panel-title">
                    <i class="fas fa-chart-bar"></i> 股票走势分析
                </div>
                
                <div class="investment-rules">
                    <h3>投资规则说明：</h3>
                    <ul>
                        <li>您初始持有 <strong>100股</strong> 当前股票</li>
                        <li>每次可以买入或卖出最多 <strong>100股</strong></li>
                        <li>您将有两次机会调整您的持仓</li>
                        <li>第二次调整前，您将看到AI投资顾问的建议</li>
                    </ul>
                </div>
                
                <div class="chart-header">
                    <div class="stock-info">
                        <div class="stock-info-item">
                            <span class="label">股票代码:</span>
                            <span class="value" id="stockSymbol">AAPL</span>
                        </div>
                        <div class="stock-info-item">
                            <span class="label">当前价格:</span>
                            <span class="value" id="currentPrice">$175.42</span>
                        </div>
                        <div class="stock-info-item">
                            <span class="label">今日涨跌:</span>
                            <span class="value" id="priceChange" style="color:#26d0ce">+1.2%</span>
                        </div>
                        <div class="stock-info-item">
                            <span class="label">交易量:</span>
                            <span class="value" id="volume">4.2M</span>
                        </div>
                    </div>
                    
                    <div class="time-filters">
                        <div class="time-btn active">1D</div>
                        <div class="time-btn">1W</div>
                        <div class="time-btn">1M</div>
                        <div class="time-btn">3M</div>
                        <div class="time-btn">1Y</div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <canvas id="stockChart"></canvas>
                </div>
            </div>
            
            <div class="decision-section">
                <div class="investment-panel">
                    <div class="panel-title">
                        <i class="fas fa-hand-holding-usd"></i> 您的投资决策
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label" for="initialInvestment">初始持仓: <strong>100股</strong></label>
                    </div>
                    
                    <div class="input-group" id="firstDecisionGroup">
                        <label class="input-label" for="firstInvestment">初次调整数量 (±100股以内)</label>
                        <input type="number" id="firstInvestment" class="input-field" min="-100" max="100" value="0" placeholder="输入买入(正数)或卖出(负数)数量">
                    </div>
                    
                    <div class="input-group" id="firstHoldingGroup">
                        <label class="input-label">初次最终持仓:</label>
                        <div style="font-size: 1.2rem; font-weight: 600; color: #1a2980;">
                            <span id="firstHolding">100</span> 股
                        </div>
                    </div>
                    
                    <button id="submitFirstDecision" class="btn">
                        <i class="fas fa-check-circle"></i> 提交初次决策
                    </button>
                    
                    <div class="ai-advice-container" id="aiAdviceContainer" style="margin-top: 30px; display: none;">
                        <div class="panel-title">
                            <i class="fas fa-robot"></i> AI投资建议
                        </div>
                        <p id="adviceStatus">请查看AI建议后做出最终决策</p>
                        <div class="ai-agents" id="aiAgents"></div>
                    </div>
                    
                    <div class="second-decision" id="secondDecision" style="margin-top: 20px; display: none;">
                        <div class="input-group">
                            <label class="input-label" for="secondInvestment">第二次调整数量 (基于AI建议)</label>
                            <input type="number" id="secondInvestment" class="input-field" min="-100" max="100" value="0" placeholder="输入买入(正数)或卖出(负数)数量">
                        </div>
                        
                        <div class="input-group">
                            <label class="input-label">最终持仓:</label>
                            <div style="font-size: 1.2rem; font-weight: 600; color: #1a2980;">
                                <span id="finalHolding">100</span> 股
                            </div>
                        </div>
                        
                        <button id="submitSecondDecision" class="btn">
                            <i class="fas fa-check-circle"></i> 提交最终决策
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="export-section" id="exportSection" style="display: none;">
            <div class="panel-title">
                <i class="fas fa-download"></i> 实验完成
            </div>
            <p>感谢您完成本次实验！您的所有决策数据已被记录。</p>
            <p>研究人员可以导出数据以供分析。</p>
            <button id="exportData" class="export-btn">
                <i class="fas fa-file-export"></i> 导出数据为CSV
            </button>
        </div>
        
        <footer>
            <p>股票投资决策实验 &copy; 2023 | 金融决策研究</p>
        </footer>
    </div>
    
    <div class="result-modal" id="resultModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">决策结果</h2>
                <p>您的投资决策已完成</p>
            </div>
            
            <div class="result-details">
                <div class="result-item">
                    <span class="result-label">初始持仓:</span>
                    <span class="result-value">100 股</span>
                </div>
                <div class="result-item">
                    <span class="result-label">初次调整:</span>
                    <span class="result-value" id="resFirstAdjustment">0 股</span>
                </div>
                <div class="result-item">
                    <span class="result-label">最终调整:</span>
                    <span class="result-value" id="resSecondAdjustment">0 股</span>
                </div>
                <div class="result-item">
                    <span class="result-label">最终持仓:</span>
                    <span class="result-value" id="resFinalHolding">100 股</span>
                </div>
            </div>
            
            <button class="close-btn" id="closeModal">
                <i class="fas fa-arrow-right"></i> 继续下一轮
            </button>
        </div>
    </div>

    <script>
        // 实验配置参数
        const experimentConfig = {
            // 实验设计参数
            conditions: [
                { aiCount: 1, explanationType: "alternatives", id: 0 },
                { aiCount: 1, explanationType: "confidence", id: 1 },
                { aiCount: 1, explanationType: "reasoning", id: 2 },
                { aiCount: 3, explanationType: "alternatives", id: 3 },
                { aiCount: 3, explanationType: "confidence", id: 4 },
                { aiCount: 3, explanationType: "reasoning", id: 5 },
                { aiCount: 5, explanationType: "alternatives", id: 6 },
                { aiCount: 5, explanationType: "confidence", id: 7 },
                { aiCount: 5, explanationType: "reasoning", id: 8 }
            ],
            roundsPerCondition: 5,
            currentConditionIndex: 0,
            currentRoundInCondition: 1,
            
            // 投资参数
            initialHolding: 100,
            maxAdjustment: 100,
            
            // 数据收集
            trialData: [] // 存储所有试次数据
        };
        
        // 实验状态
        const experimentState = {
            currentStock: "",
            currentTrendType: "",
            conditionOrder: [],
            firstAdjustment: 0,
            secondAdjustment: 0,
            finalHolding: 100,
            usedTrendTypes: [],
            currentAIConsensus: 0, // AI共识平均值
            aiRecommendations: [], // 各个AI的具体建议
            consensusDirection: "buy" // 共识方向
        };
        
        // 图表实例
        let stockChart;
        
        // 初始化实验
        document.addEventListener('DOMContentLoaded', function() {
            // 随机化条件顺序
            experimentState.conditionOrder = [...experimentConfig.conditions].sort(() => Math.random() - 0.5);
            
            // 设置输入事件
            document.getElementById('firstInvestment').addEventListener('input', updateFirstHolding);
            document.getElementById('secondInvestment').addEventListener('input', updateFinalHolding);
            
            document.getElementById('submitFirstDecision').addEventListener('click', handleFirstDecisionSubmission);
            document.getElementById('submitSecondDecision').addEventListener('click', handleSecondDecisionSubmission);
            document.getElementById('closeModal').addEventListener('click', closeResultModal);
            document.getElementById('exportData').addEventListener('click', exportDataToCSV);
            
            // 开始第一轮
            startNewRound();
        });
        
        // 开始新一轮
        function startNewRound() {
            // 获取当前条件
            const currentCondition = experimentState.conditionOrder[experimentConfig.currentConditionIndex];
            
            // 选择未使用的趋势类型
            let availableTrends = ["strongUp", "moderateUp", "stable", "moderateDown", "strongDown"]
                .filter(trend => !experimentState.usedTrendTypes.includes(trend));
            
            // 如果所有类型都已使用，重置列表
            if (availableTrends.length === 0) {
                experimentState.usedTrendTypes = [];
                availableTrends = ["strongUp", "moderateUp", "stable", "moderateDown", "strongDown"];
            }
            
            // 随机选择趋势类型
            const randomIndex = Math.floor(Math.random() * availableTrends.length);
            const selectedTrend = availableTrends[randomIndex];
            experimentState.currentTrendType = selectedTrend;
            experimentState.usedTrendTypes.push(selectedTrend);
            
            // 生成股票数据（基于趋势类型和条件ID）
            const stockData = generateStockData(selectedTrend, currentCondition.id);
            
            // 设置股票信息
            experimentState.currentStock = stockData.symbol;
            document.getElementById('stockSymbol').textContent = stockData.symbol;
            document.getElementById('currentPrice').textContent = `$${stockData.currentPrice.toFixed(2)}`;
            
            // 计算涨跌幅
            const changeElement = document.getElementById('priceChange');
            changeElement.textContent = `${stockData.changePercent >= 0 ? '+' : ''}${stockData.changePercent}%`;
            changeElement.style.color = stockData.changePercent >= 0 ? '#26d0ce' : '#e74c3c';
            
            // 设置交易量
            document.getElementById('volume').textContent = `${(stockData.volume / 1000000).toFixed(1)}M`;
            
            // 设置共识方向
            experimentState.consensusDirection = stockData.consensusDirection;
            
            // 渲染股票图表
            renderStockChart(stockData.data);
            
            // 重置投资决策
            resetDecisionForms();
            
            // 确保初始决策区域可见
            document.getElementById('firstDecisionGroup').style.display = 'block';
            document.getElementById('firstHoldingGroup').style.display = 'block';
            document.getElementById('submitFirstDecision').style.display = 'block';
            
            // 隐藏AI建议和第二次决策界面
            document.getElementById('aiAdviceContainer').style.display = 'none';
            document.getElementById('secondDecision').style.display = 'none';
            
            // 清空AI建议容器
            document.getElementById('aiAgents').innerHTML = '';
            
            // 重置AI建议状态
            experimentState.aiRecommendations = [];
            experimentState.currentAIConsensus = 0;
        }
        
        // 生成股票数据（基于趋势类型和条件ID）
        function generateStockData(trendType, conditionId) {
            const data = [];
            let price;
            
            // 根据趋势类型设置初始价格
            switch(trendType) {
                case "strongUp":
                    price = 150 + conditionId * 0.5;
                    break;
                case "moderateUp":
                    price = 160 + conditionId * 0.3;
                    break;
                case "stable":
                    price = 170 + conditionId * 0.2;
                    break;
                case "moderateDown":
                    price = 180 - conditionId * 0.3;
                    break;
                case "strongDown":
                    price = 190 - conditionId * 0.5;
                    break;
                default:
                    price = 170;
            }
            
            const volumes = [];
            
            for (let i = 0; i < 30; i++) {
                // 基于趋势类型和条件ID生成确定性波动
                let change;
                switch(trendType) {
                    case "strongUp":
                        change = (Math.sin(i/3) + 0.8 + Math.cos(conditionId + i/2)*0.3) * 0.8;
                        break;
                    case "moderateUp":
                        change = (Math.sin(i/4) + 0.5 + Math.sin(conditionId + i/3)*0.4) * 0.6;
                        break;
                    case "stable":
                        change = (Math.sin(i/5) + Math.cos(conditionId + i/4)*0.7) * 0.4;
                        break;
                    case "moderateDown":
                        change = (Math.sin(i/4) - 0.5 + Math.sin(conditionId + i/3)*0.4) * 0.6;
                        break;
                    case "strongDown":
                        change = (Math.sin(i/3) - 0.8 + Math.cos(conditionId + i/2)*0.3) * 0.8;
                        break;
                    default:
                        change = (Math.random() - 0.5) * 1.5;
                }
                
                // 添加基于条件ID的微小随机扰动
                const minorVariation = (Math.sin(conditionId * 10 + i) * 0.1);
                price += change + minorVariation;
                
                // 交易量
                const volume = Math.floor(2000000 + Math.abs(change)*1000000 + Math.random()*3000000);
                volumes.push(volume);
                
                data.push({
                    day: i + 1,
                    price: parseFloat(price.toFixed(2)),
                    volume: volume
                });
            }
            
            // 计算涨跌幅
            const prevDayPrice = data[28].price;
            const changePercent = ((data[29].price - prevDayPrice) / prevDayPrice * 100).toFixed(2);
            
            // 分配股票代码（基于趋势类型和条件ID）
            const symbols = ["AAPL", "MSFT", "GOOGL", "AMZN", "TSLA", "META", "NVDA", "NFLX", "AMD"];
            const symbolIndex = (trendType.charCodeAt(0) + conditionId) % symbols.length;
            const symbol = symbols[symbolIndex];
            
            // 设置共识方向（基于趋势类型）
            let consensusDirection;
            if (trendType.includes("Up")) {
                consensusDirection = "buy";
            } else if (trendType.includes("Down")) {
                consensusDirection = "sell";
            } else {
                // 对于稳定趋势，随机分配方向
                consensusDirection = Math.random() > 0.5 ? "buy" : "sell";
            }
            
            return {
                symbol: symbol,
                trendType: trendType,
                data: data,
                currentPrice: data[29].price,
                changePercent: parseFloat(changePercent),
                volume: volumes[29],
                consensusDirection: consensusDirection
            };
        }
        
        // 渲染股票图表
        function renderStockChart(data) {
            const ctx = document.getElementById('stockChart');
            if (!ctx) return;
            
            // 销毁之前的图表实例
            if (stockChart) {
                stockChart.destroy();
            }
            
            // 创建渐变背景
            const gradient = ctx.getContext('2d').createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(26, 41, 128, 0.2)');
            gradient.addColorStop(1, 'rgba(38, 208, 206, 0.05)');
            
            // 生成日期标签
            const today = new Date();
            const labels = [];
            for (let i = 29; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                labels.push(date.toLocaleDateString('zh-CN', { 
                    month: 'short', 
                    day: 'numeric'
                }));
            }
            
            stockChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: `${experimentState.currentStock} 股价`,
                        data: data.map(item => item.price),
                        borderColor: '#1a2980',
                        backgroundColor: gradient,
                        borderWidth: 3,
                        tension: 0.2,
                        fill: true,
                        pointBackgroundColor: '#fff',
                        pointBorderColor: '#1a2980',
                        pointBorderWidth: 2,
                        pointRadius: 3,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(26, 41, 128, 0.9)',
                            padding: 12,
                            titleFont: {
                                size: 14,
                                weight: 'bold'
                            },
                            bodyFont: {
                                size: 13
                            },
                            callbacks: {
                                label: function(context) {
                                    return `价格: $${context.parsed.y.toFixed(2)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            title: {
                                display: true,
                                text: '价格 (USD)',
                                font: {
                                    size: 13,
                                    weight: 'bold'
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                maxRotation: 0,
                                autoSkip: true,
                                maxTicksLimit: 10
                            }
                        }
                    },
                    animation: {
                        duration: 2000,
                        easing: 'easeOutQuart'
                    }
                }
            });
        }
        
        // 重置决策表单
        function resetDecisionForms() {
            document.getElementById('firstInvestment').value = '0';
            document.getElementById('secondInvestment').value = '0';
            experimentState.firstAdjustment = 0;
            experimentState.secondAdjustment = 0;
            experimentState.finalHolding = experimentConfig.initialHolding;
            document.getElementById('firstHolding').textContent = experimentConfig.initialHolding;
            document.getElementById('finalHolding').textContent = experimentConfig.initialHolding;
            document.getElementById('submitFirstDecision').disabled = false;
            document.getElementById('submitSecondDecision').disabled = true;
            
            // 确保第二次决策的输入框可用
            document.getElementById('secondInvestment').disabled = false;
        }
        
        // 更新初次持仓显示
        function updateFirstHolding() {
            const adjustmentInput = document.getElementById('firstInvestment');
            let adjustment = parseInt(adjustmentInput.value) || 0;
            
            // 确保调整在允许范围内
            if (adjustment > experimentConfig.maxAdjustment) {
                adjustment = experimentConfig.maxAdjustment;
                adjustmentInput.value = adjustment;
            } else if (adjustment < -experimentConfig.maxAdjustment) {
                adjustment = -experimentConfig.maxAdjustment;
                adjustmentInput.value = adjustment;
            }
            
            experimentState.firstAdjustment = adjustment;
            const firstHolding = experimentConfig.initialHolding + adjustment;
            document.getElementById('firstHolding').textContent = firstHolding;
        }
        
        // 更新最终持仓显示
        function updateFinalHolding() {
            const adjustmentInput = document.getElementById('secondInvestment');
            let adjustment = parseInt(adjustmentInput.value) || 0;
            
            // 确保调整在允许范围内
            if (adjustment > experimentConfig.maxAdjustment) {
                adjustment = experimentConfig.maxAdjustment;
                adjustmentInput.value = adjustment;
            } else if (adjustment < -experimentConfig.maxAdjustment) {
                adjustment = -experimentConfig.maxAdjustment;
                adjustmentInput.value = adjustment;
            }
            
            experimentState.secondAdjustment = adjustment;
            experimentState.finalHolding = experimentConfig.initialHolding + experimentState.firstAdjustment + adjustment;
            document.getElementById('finalHolding').textContent = experimentState.finalHolding;
        }
        
        // 生成AI建议（围绕共识平均值浮动）
        function generateAIAdvice(condition) {
            const aiAgentsContainer = document.getElementById('aiAgents');
            const adviceStatus = document.getElementById('adviceStatus');
            
            // 清除状态信息
            adviceStatus.textContent = `${condition.aiCount}个AI投资顾问正在思考...`;
            
            // 获取共识方向
            const consensusDirection = experimentState.consensusDirection;
            
            // 确定共识平均值（基于趋势类型和条件）
            let consensusAverage;
            switch(experimentState.currentTrendType) {
                case "strongUp":
                    consensusAverage = 70 + condition.id * 2;
                    break;
                case "moderateUp":
                    consensusAverage = 50 + condition.id * 1.5;
                    break;
                case "stable":
                    consensusAverage = 30 + condition.id * 1;
                    break;
                case "moderateDown":
                    consensusAverage = -40 - condition.id * 1.5;
                    break;
                case "strongDown":
                    consensusAverage = -70 - condition.id * 2;
                    break;
                default:
                    consensusAverage = 30;
            }
            
            // 存储共识平均值
            experimentState.currentAIConsensus = consensusAverage;
            
            // 生成每个AI代理建议
            for (let i = 1; i <= condition.aiCount; i++) {
                setTimeout(() => {
                    // 生成围绕共识平均值的浮动建议
                    let recommendedAmount;
                    if (condition.aiCount === 1) {
                        // 单个AI时使用共识平均值
                        recommendedAmount = consensusAverage;
                    } else {
                        // 多个AI时围绕共识平均值浮动
                        const variation = Math.random() * 30 - 15; // -15到+15的浮动
                        recommendedAmount = Math.round(consensusAverage + variation);
                        
                        // 确保建议方向与共识一致
                        if ((consensusAverage > 0 && recommendedAmount < 0) || 
                            (consensusAverage < 0 && recommendedAmount > 0)) {
                            recommendedAmount = -recommendedAmount;
                        }
                        
                        // 确保在有效范围内
                        recommendedAmount = Math.max(
                            Math.min(recommendedAmount, experimentConfig.maxAdjustment),
                            -experimentConfig.maxAdjustment
                        );
                    }
                    
                    // 存储AI建议
                    experimentState.aiRecommendations.push({
                        aiNumber: i,
                        recommendedAmount: recommendedAmount,
                        direction: recommendedAmount >= 0 ? "买入" : "卖出"
                    });
                    
                    createConsistentAIAdvice(i, aiAgentsContainer, condition.explanationType, consensusDirection, recommendedAmount);
                    
                    // 更新状态信息
                    if (i === condition.aiCount) {
                        adviceStatus.textContent = `${condition.aiCount}个AI投资顾问的建议：`;
                    }
                }, i * 1500);
            }
        }
        
        // 创建方向一致的AI建议
        function createConsistentAIAdvice(aiNumber, container, explanationType, consensusDirection, recommendedAmount) {
            const agentDiv = document.createElement('div');
            agentDiv.className = 'ai-agent';
            
            // 创建AI代理头信息
            const agentHeader = document.createElement('div');
            agentHeader.className = 'agent-header';
            
            const agentIcon = document.createElement('div');
            agentIcon.className = 'agent-icon';
            agentIcon.textContent = `${aiNumber}`;
            
            const agentName = document.createElement('div');
            agentName.className = 'agent-name';
            agentName.textContent = getRandomAIName();
            
            // 添加"思考中"动画
            const thinkingDots = document.createElement('div');
            thinkingDots.className = 'thinking';
            thinkingDots.innerHTML = `
                <div class="dot"></div>
                <div class="dot"></div>
                <div class="dot"></div>
            `;
            
            agentHeader.appendChild(agentIcon);
            agentHeader.appendChild(agentName);
            agentHeader.appendChild(thinkingDots);
            
            // 建议内容容器
            const adviceContent = document.createElement('div');
            adviceContent.className = 'advice-content';
            adviceContent.style.display = 'none';
            
            agentDiv.appendChild(agentHeader);
            agentDiv.appendChild(adviceContent);
            container.appendChild(agentDiv);
            
            // 显示AI卡片
            setTimeout(() => {
                agentDiv.classList.add('visible');
                
                // 模拟AI思考时间
                setTimeout(() => {
                    // 移除思考动画
                    thinkingDots.remove();
                    
                    // 生成建议内容
                    generateConsistentAdviceContent(adviceContent, explanationType, consensusDirection, recommendedAmount);
                    
                    // 显示建议内容
                    adviceContent.style.display = 'block';
                }, 1000 + Math.random() * 1000);
            }, 100);
        }
        
        // 生成方向一致的建议内容
        function generateConsistentAdviceContent(container, explanationType, consensusDirection, recommendedAmount) {
            const action = recommendedAmount >= 0 ? '买入' : '卖出';
            const absAmount = Math.abs(recommendedAmount);
            
            switch(explanationType) {
                case 'alternatives':
                    container.innerHTML = `
                        <div class="recommendation">
                            <strong>建议操作：</strong> ${action} ${absAmount} 股
                        </div>
                        <div class="alternative-options">
                            <div>${action} ${absAmount} 股（${getRandomAdjective()}策略）<br><small>${generateTechnicalAnalysis(consensusDirection)}</small></div>
                            <div>${action} ${Math.floor(absAmount * 0.7)} 股（${getRandomAdjective()}策略）<br><small>${generateFundamentalAnalysis(consensusDirection)}</small></div>
                            <div>持有当前仓位（中性观望）<br><small>${generateMarketSentimentAnalysis(consensusDirection)}</small></div>
                        </div>
                    `;
                    break;
                    
                case 'confidence':
                    const confidence = getRandomConfidence();
                    container.innerHTML = `
                        <div class="recommendation">
                            <strong>建议操作：</strong> ${action} ${absAmount} 股
                        </div>
                        <div class="confidence">置信度: ${confidence}%</div>
                        <div class="reasoning">${generateConfidenceReasoning(confidence, consensusDirection)}</div>
                    `;
                    break;
                    
                case 'reasoning':
                    container.innerHTML = `
                        <div class="recommendation">
                            <strong>建议操作：</strong> ${action} ${absAmount} 股
                        </div>
                        <div class="reasoning">
                            <strong>分析依据：</strong><br>
                            ${generateComprehensiveReasoning(consensusDirection)}
                        </div>
                    `;
                    break;
            }
        }
        
        // 处理初次决策提交
        function handleFirstDecisionSubmission() {
            // 验证输入
            const adjustment = parseInt(document.getElementById('firstInvestment').value);
            if (isNaN(adjustment) || adjustment < -experimentConfig.maxAdjustment || adjustment > experimentConfig.maxAdjustment) {
                alert(`请输入有效的调整数量（-${experimentConfig.maxAdjustment}到${experimentConfig.maxAdjustment}之间）`);
                return;
            }
            
            // 显示AI建议
            document.getElementById('aiAdviceContainer').style.display = 'block';
            document.getElementById('submitFirstDecision').disabled = true;
            
            // 隐藏初始决策区域
            document.getElementById('firstDecisionGroup').style.display = 'none';
            document.getElementById('firstHoldingGroup').style.display = 'none';
            document.getElementById('submitFirstDecision').style.display = 'none';
            
            // 生成并显示AI建议
            const currentCondition = experimentState.conditionOrder[experimentConfig.currentConditionIndex];
            generateAIAdvice(currentCondition);
            
            // 启用第二次决策
            document.getElementById('secondDecision').style.display = 'block';
            document.getElementById('submitSecondDecision').disabled = false;
            
            // 确保第二次决策的输入框可用
            document.getElementById('secondInvestment').disabled = false;
        }
        
        // 处理第二次决策提交
        function handleSecondDecisionSubmission() {
            // 验证输入
            const secondAdjustment = parseInt(document.getElementById('secondInvestment').value);
            if (isNaN(secondAdjustment) || secondAdjustment < -experimentConfig.maxAdjustment || secondAdjustment > experimentConfig.maxAdjustment) {
                alert(`请输入有效的调整数量（-${experimentConfig.maxAdjustment}到${experimentConfig.maxAdjustment}之间）`);
                return;
            }
            
            // 计算从众行为指标
            const firstHolding = experimentConfig.initialHolding + experimentState.firstAdjustment;
            const finalHolding = firstHolding + secondAdjustment;
            
            // 计算从众度
            let conformityScore = 0;
            if (finalHolding > firstHolding && experimentState.consensusDirection === 'buy') {
                conformityScore = finalHolding - firstHolding;
            } else if (finalHolding < firstHolding && experimentState.consensusDirection === 'sell') {
                conformityScore = finalHolding - firstHolding;
            } else {
                conformityScore = finalHolding - firstHolding;
            }
            
            // 记录试验数据
            recordTrialData(secondAdjustment);
            
            // 显示结果
            showResultModal(experimentState.firstAdjustment, secondAdjustment, conformityScore);
            
            // 禁用提交按钮
            document.getElementById('submitSecondDecision').disabled = true;
        }
        
        // 记录试验数据
        function recordTrialData(secondAdjustment) {
            const currentCondition = experimentState.conditionOrder[experimentConfig.currentConditionIndex];
            const firstAdjustment = experimentState.firstAdjustment;
            
            // 计算调整比率
            let adjustmentRatio = 0;
            if (experimentState.currentAIConsensus !== firstAdjustment) {
                adjustmentRatio = (secondAdjustment - firstAdjustment) / 
                                 (experimentState.currentAIConsensus - firstAdjustment);
            }
            
            // 只记录必要的数据
            const trialData = {
                trialNumber: (experimentConfig.currentConditionIndex * experimentConfig.roundsPerCondition) + experimentConfig.currentRoundInCondition,
                trendType: experimentState.currentTrendType,
                aiCount: currentCondition.aiCount,
                explanationType: currentCondition.explanationType,
                firstDecision: firstAdjustment,
                aiConsensus: experimentState.currentAIConsensus,
                secondAdjustment: secondAdjustment,
                adjustmentRatio: adjustmentRatio
            };
            
            experimentConfig.trialData.push(trialData);
            console.log("记录试验数据:", trialData);
        }
        
        // 显示结果模态框
        function showResultModal(firstAdjustment, secondAdjustment, score) {
            document.getElementById('resFirstAdjustment').textContent = 
                `${firstAdjustment >= 0 ? '+' : ''}${firstAdjustment} 股`;
            document.getElementById('resSecondAdjustment').textContent = 
                `${secondAdjustment >= 0 ? '+' : ''}${secondAdjustment} 股`;
            document.getElementById('resFinalHolding').textContent = 
                `${experimentConfig.initialHolding + firstAdjustment + secondAdjustment} 股`;
            
            document.getElementById('resultModal').classList.add('active');
        }
        
        // 导出数据为CSV
        function exportDataToCSV() {
            if (experimentConfig.trialData.length === 0) {
                alert("没有数据可导出");
                return;
            }
            
            // 创建CSV内容
            let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
            
            // 添加表头（中英文对照）
            const headers = [
                "试次Trial",
                "股票类型StockType", 
                "AI数量AICount",
                "AI建议形式ExplanationType",
                "第一次决策值FirstDecision", 
                "AI建议平均值AIConsensus",
                "第二次调整值SecondAdjustment",
                "调整比率AdjustmentRatio"
            ];
            csvContent += headers.join(",") + "\n";
            
            // 添加数据行
            experimentConfig.trialData.forEach(row => {
                const values = [
                    row.trialNumber,
                    getTrendTypeChinese(row.trendType),
                    row.aiCount,
                    getExplanationTypeChinese(row.explanationType),
                    row.firstDecision,
                    row.aiConsensus.toFixed(2),
                    row.secondAdjustment,
                    row.adjustmentRatio.toFixed(4)
                ];
                csvContent += values.join(",") + "\n";
            });
            
            // 创建下载链接
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "股票投资实验数据.csv");
            document.body.appendChild(link);
            
            // 触发下载
            link.click();
            
            // 清理
            document.body.removeChild(link);
        }

        // 辅助函数：获取趋势类型的中文名称
        function getTrendTypeChinese(trendType) {
            const trendMap = {
                "strongUp": "强劲上涨",
                "moderateUp": "温和上涨", 
                "stable": "横盘震荡",
                "moderateDown": "温和下跌",
                "strongDown": "强劲下跌"
            };
            return trendMap[trendType] || trendType;
        }

        // 辅助函数：获取解释类型的中文名称
        function getExplanationTypeChinese(explanationType) {
            const explanationMap = {
                "alternatives": "替代建议",
                "confidence": "置信度",
                "reasoning": "推理过程"
            };
            return explanationMap[explanationType] || explanationType;
        }
        
        // 关闭结果模态框
        function closeResultModal() {
            document.getElementById('resultModal').classList.remove('active');
            
            // 更新轮次信息
            experimentConfig.currentRoundInCondition++;
            
            // 检查是否所有条件都已完成
            if (experimentConfig.currentRoundInCondition > experimentConfig.roundsPerCondition) {
                // 当前条件的所有轮次已完成，切换到下一个条件
                experimentConfig.currentConditionIndex++;
                experimentConfig.currentRoundInCondition = 1;
                
                // 检查是否所有条件都已完成
                if (experimentConfig.currentConditionIndex >= experimentState.conditionOrder.length) {
                    // 实验结束，显示导出选项
                    document.getElementById('exportSection').style.display = 'block';
                    return;
                }
            }
            
            // 开始新一轮
            startNewRound();
        }
        
        // 辅助函数 - 随机生成AI名称
        function getRandomAIName() {
            const names = ["高盛量化模型", "摩根AI分析", "瑞银智能投顾", "贝莱德算法", "桥水策略AI", 
                          "富达投资助手", "先锋智能分析", "道富量化系统", "黑石AI顾问"];
            return names[Math.floor(Math.random() * names.length)];
        }
        
        // 辅助函数 - 随机生成形容词
        function getRandomAdjective() {
            const adjectives = ["激进", "稳健", "保守", "灵活", "平衡", "趋势", "反转", "价值", "成长"];
            return adjectives[Math.floor(Math.random() * adjectives.length)];
        }
        
        // 辅助函数 - 随机生成置信度
        function getRandomConfidence() {
            return Math.floor(Math.random() * 21) + 75;
        }
        
        // 生成技术分析
        function generateTechnicalAnalysis(direction) {
            const indicators = [
                `股价${direction === 'buy' ? '突破' : '跌破'}关键${direction === 'buy' ? '阻力位' : '支撑位'}，${direction === 'buy' ? 'MACD金叉形成' : 'MACD死叉确认'}`,
                `RSI指标显示${direction === 'buy' ? '超卖' : '超买'}状态，价格${direction === 'buy' ? '回升' : '回落'}至关键水平`,
                `布林带宽度${direction === 'buy' ? '收窄' : '扩大'}，价格触碰${direction === 'buy' ? '下轨' : '上轨'}，预示${direction === 'buy' ? '反弹' : '下跌'}可能性增加`,
                `均线系统显示短期均线${direction === 'buy' ? '向上金叉' : '向下死叉'}长期均线，趋势转向${direction === 'buy' ? '多头' : '空头'}`
            ];
            return indicators[Math.floor(Math.random() * indicators.length)];
        }
        
        // 生成基本面分析
        function generateFundamentalAnalysis(direction) {
            const fundamentals = [
                `${direction === 'buy' ? '强劲' : '疲软'}的季度财报显示公司${direction === 'buy' ? '盈利能力增强' : '业绩不及预期'}`,
                `行业分析师${direction === 'buy' ? '上调目标价' : '下调目标价'}，预期未来12个月股价${direction === 'buy' ? '上涨空间达20%' : '可能面临回调压力'}`,
                `公司宣布${direction === 'buy' ? '股票回购计划' : '增发新股'}, 对股价${direction === 'buy' ? '构成支撑' : '造成短期压力'}`,
                `管理层${direction === 'buy' ? '乐观' : '保守'}的业绩展望，${direction === 'buy' ? '增强' : '削弱'}市场信心`
            ];
            return fundamentals[Math.floor(Math.random() * fundamentals.length)];
        }
        
        // 生成市场情绪分析
        function generateMarketSentimentAnalysis(direction) {
            const sentiment = [
                `投资者情绪${direction === 'buy' ? '转向乐观' : '转为谨慎'}, ${direction === 'buy' ? '看涨' : '看跌'}期权未平仓合约增加显著`,
                `社交媒体和新闻舆论呈现${direction === 'buy' ? '正面' : '负面'}基调，零售投资者兴趣${direction === 'buy' ? '升温' : '降温'}`,
                `机构资金流向显示${direction === 'buy' ? '连续5个交易日净流入' : '大额卖单涌现'}, 大资金${direction === 'buy' ? '进场' : '撤出'}迹象明显`,
                `行业板块${direction === 'buy' ? '轮动至当前股票' : '从当前股票流出'}, 板块内资金${direction === 'buy' ? '聚集效应明显' : '分散迹象突出'}`
            ];
            return sentiment[Math.floor(Math.random() * sentiment.length)];
        }
        
        // 生成置信度解释
        function generateConfidenceReasoning(confidence, direction) {
            const reasons = [
                `技术指标显示${confidence > 85 ? "强烈" : "中等"}信号，${confidence > 90 ? "强烈建议" : "建议"}${direction === 'buy' ? '买入' : '卖出'}`,
                `基本面因素${confidence > 85 ? "高度支持" : "部分支持"}${direction === 'buy' ? '多方' : '空方'}观点，${confidence > 90 ? "明确" : "暗示"}${direction === 'buy' ? '上涨' : '下跌'}潜力`,
                `市场情绪指标与技术分析${confidence > 85 ? "高度一致" : "部分吻合"}，${confidence > 90 ? "强烈" : "中等"}支持${direction === 'buy' ? '看涨' : '看跌'}判断`,
                `量化模型预测显示${direction === 'buy' ? '上涨' : '下跌'}概率为${confidence}%, 风险收益比${direction === 'buy' ? '有利' : '不利'}`
            ];
            return reasons[Math.floor(Math.random() * reasons.length)];
        }
        
        // 生成综合推理
        function generateComprehensiveReasoning(direction) {
            return `
                <p>${generateTechnicalAnalysis(direction)}</p>
                <p>${generateFundamentalAnalysis(direction)}</p>
                <p>${generateMarketSentimentAnalysis(direction)}</p>
            `;
        }
    </script>
</body>
</html>